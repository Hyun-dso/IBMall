<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itbank.mall.mapper.orders.OrderDetailMapper">

  <!-- 주문 상세 조회 -->
  <select id="findOrderDetailById" resultType="com.itbank.mall.dto.orders.OrderDetailDto">
    SELECT
      o.order_id        AS orderId,
      o.created_at      AS createdAt,
      o.status          AS orderStatus,
      o.buyer_name      AS buyerName,
      p.name            AS productName,
      p.price           AS productPrice,
      -- p.image_url      AS imageUrl,
      oi.quantity       AS quantity,
      (oi.quantity * oi.price) AS itemTotal,  <!-- ✅ 옵션가 포함 단가(oi.price) 기준으로 합계 계산 -->

      d.address1         AS deliveryAddress1,
      d.address2         AS deliveryAddress2,
      d.recipient       AS recipient,
      d.phone           AS phone,
      d.tracking_number AS trackingNumber,
      d.status          AS deliveryStatus

    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN product p      ON oi.product_id = p.product_id
    JOIN deliveries d   ON o.order_id = d.order_id

    WHERE o.order_id = #{orderId}
  </select>
  
    <!-- 주문 UID 로 주문 상세 조회 -->
  <select id="findOrderDetailByUid" resultType="com.itbank.mall.dto.orders.OrderDetailDto">
    SELECT
      o.order_id        AS orderId,
      o.created_at      AS createdAt,
      o.status          AS orderStatus,
      o.buyer_name      AS buyerName,
      p.name            AS productName,
      p.price           AS productPrice,
      -- p.image_url      AS imageUrl,
      oi.quantity       AS quantity,
      (oi.quantity * oi.price) AS itemTotal,

      d.address1         AS deliveryAddress1,
      d.address2         AS deliveryAddress2,
      d.recipient       AS recipient,
      d.phone           AS phone,
      d.tracking_number AS trackingNumber,
      d.status          AS deliveryStatus

    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN product p      ON oi.product_id = p.product_id
    JOIN deliveries d   ON o.order_id = d.order_id

    WHERE o.order_uid = #{orderUid}
  	</select>

</mapper>
