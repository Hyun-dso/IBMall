<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itbank.mall.mapper.admin.ProductImageMapper">

    <!-- ✅ 1. 이미지 1개 추가 -->
    <insert id="insert" parameterType="com.itbank.mall.entity.product.ProductImage">
        INSERT INTO product_image (product_id, image_url, sort_order)
        VALUES (#{productId}, #{imageUrl}, #{sortOrder})
    </insert>

    <!-- ✅ 2. 특정 상품의 이미지들 조회 (정렬 순서 기준) -->
    <select id="findByProductId" parameterType="long"
            resultType="com.itbank.mall.entity.product.ProductImage">
        SELECT image_id     AS imageId,
               product_id   AS productId,
               image_url    AS imageUrl,
               sort_order   AS sortOrder,
               created_at   AS createdAt
        FROM product_image
        WHERE product_id = #{productId}
        ORDER BY sort_order ASC
    </select>

    <!-- ✅ 3. 특정 상품 이미지들 전체 삭제 -->
    <delete id="deleteByProductId" parameterType="long">
        DELETE FROM product_image
        WHERE product_id = #{productId}
    </delete>

    <!-- ✅ 4. 썸네일 설정 (product 테이블의 thumbnail_url 컬럼에 image_url 저장) -->
    <update id="updateProductThumbnail">
        UPDATE product
        SET thumbnail_url = (
            SELECT image_url
            FROM product_image
            WHERE image_id = #{imageId}
            LIMIT 1
        )
        WHERE product_id = #{productId}
    </update>

    <!-- ✅ 5. 이미지 정렬 순서 변경 -->
    <update id="updateSortOrder">
        UPDATE product_image
        SET sort_order = #{sortOrder}
        WHERE image_id = #{imageId}
    </update>

</mapper>
