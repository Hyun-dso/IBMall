<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itbank.mall.mapper.admin.GradeUpdateMapper">

	<!-- 전체 회원: 최근 1년 누적 + 현재 등급 동시 조회 -->
	<select id="findMembersWithTotalSpent"
		resultType="com.itbank.mall.dto.admin.grade.MemberGradeDto">
		SELECT
		m.id AS memberId,
		COALESCE(SUM(o.total_price), 0) AS totalSpent,
		COALESCE(m.grade, 'BASIC') AS matchedGrade
		FROM member m
		LEFT JOIN orders o
		ON o.member_id = m.id
		AND o.created_at >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
		GROUP BY m.id, m.grade
	</select>

	<select id="findGradeRules"
		resultType="com.itbank.mall.entity.grade.GradeRuleEntity">
		SELECT grade_name AS gradeName, min_spending AS minSpending
		FROM grade_rule
		ORDER BY min_spending DESC
	</select>

	<!-- 특정 회원: 최근 1년 누적 + 현재 등급 동시 조회 -->
	<select id="findMemberWithTotalSpentById"
		resultType="com.itbank.mall.dto.admin.grade.MemberGradeDto">
		SELECT
		m.id AS memberId,
		COALESCE(SUM(o.total_price), 0) AS totalSpent,
		COALESCE(m.grade, 'BASIC') AS matchedGrade
		FROM member m
		LEFT JOIN orders o
		ON o.member_id = m.id
		AND o.created_at >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
		WHERE m.id = #{memberId}
		GROUP BY m.id, m.grade
	</select>

	<update id="updateMemberGrade">
		UPDATE member
		SET grade = UPPER(#{grade})
		WHERE id = #{memberId}
	</update>

</mapper>